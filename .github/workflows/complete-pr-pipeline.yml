name: Complete PR Pipeline

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: write
  issues: write
  checks: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      build_status: ${{ steps.build.outputs.status }}
      test_status: ${{ steps.test.outputs.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        id: build
        run: |
          if dotnet build --no-restore; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Test
        id: test
        if: steps.build.outputs.status == 'success'
        run: |
          if dotnet test --no-build --verbosity normal; then
            echo "status=success" >> $GITHWB_OUTPUT
          else
            echo "status=failed" >> $GITHWB_OUTPUT
          fi
        continue-on-error: true

  request-coderabbit-tests:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      needs.build-and-test.outputs.build_status == 'success'
    steps:
      - name: Request unit tests from CodeRabbit
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });
            const requested = comments.some(c => c.body.includes('@coderabbitai generate unit tests'));
            if (!requested) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '@coderabbitai generate unit tests - xUnit with NSubstitute. Cover happy paths, edge cases, errors. Commit to PR branch.'
              });
            }

  post-status:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Update PR status
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ needs.build-and-test.outputs.build_status }}';
            const testStatus = '${{ needs.build-and-test.outputs.test_status }}';
            const allGreen = buildStatus === 'success' && testStatus === 'success';
            if (allGreen) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['ready-to-merge']
              });
            }
